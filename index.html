<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Spanish IPA Transcriber — Original (only ch→tʃ fix)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Georgia, serif;
      color: #2c3e50;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; margin: 0; padding: 20px;
    }
    .container {
      max-width: 1200px; margin: 0 auto; background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px); border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      color: #fff; padding: 30px; text-align: center;
    }
    .header h1 { margin: 0 0 10px; font-size: 2.4rem; }
    .subtitle { opacity: 0.9; }
    .main { padding: 30px 40px 40px; }
    .input-section h2, .output-section h2 { margin: 0 0 10px; }
    textarea {
      width: 100%; height: 140px; padding: 15px;
      border: 2px solid #e0e6ed; border-radius: 10px; font-size: 16px; resize: vertical;
    }
    .controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin: 16px 0; }
    .transcribe-btn {
      background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border: none;
      padding: 10px 18px; border-radius: 8px; font-weight: 700; cursor: pointer;
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
    }
    .panel {
      background: #fff; border-radius: 12px; padding: 16px; margin-top: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .feature-grid {
      display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
    }
    .feature-item { display: flex; align-items: center; gap: 8px; }
    .output-section { margin-top: 24px; background: #f8f9fa; border-radius: 12px; padding: 18px; }
    .transcription-result {
      background: #fff; border: 2px solid #e0e6ed; border-radius: 10px; padding: 16px;
      font-family: "Courier New", monospace; font-size: 18px; line-height: 1.7; white-space: pre-wrap;
      min-height: 90px;
    }

    /* Small auxiliary panel from your other UI (kept to honor original) */
    .side-panel { margin-top: 26px; }
    .row { display: grid; grid-template-columns: 1fr 340px; gap: 16px; }
    @media (max-width: 980px) { .row { grid-template-columns: 1fr; } }
    .mini-panel { border: 1px solid #e0e6ed; border-radius: 10px; padding: 14px; background: #fff; }
    .mini-output { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #fafafa; border-radius: 8px; padding: 12px; }
    .small { color: #667; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Spanish IPA Transcriber — Complete Engine</h1>
      <p class="subtitle">Dominican, Mexican, Rioplatense, and Cádiz varieties with proper syllabification</p>
    </div>

    <div class="main">
      <div class="row">
        <div>
          <div class="panel input-section">
            <h2>Enter Spanish Text</h2>
            <textarea id="inputText">hola chicos ..</textarea>

            <div class="controls">
              <label for="dialectSelect">Choose dialect:</label>
              <select id="dialectSelect">
                <option value="dominican">Dominican (Santo Domingo)</option>
                <option value="mexican">Mexican (Mexico City)</option>
                <option value="rioplatense">Rioplatense (Buenos Aires/Montevideo)</option>
                <option value="cadiz">Cádiz (Andalusian)</option>
              </select>

              <button class="transcribe-btn" onclick="transcribe()">Transcribe</button>
            </div>
          </div>

          <div class="panel">
            <h3>Features</h3>
            <div class="feature-grid">
              <!-- From your top snippet -->
              <div class="feature-item">
                <input type="checkbox" id="liquidSubCadiz" checked>
                <label for="liquidSubCadiz">Liquid substitution r→l̪ (Cádiz)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="nVelarization" checked>
                <label for="nVelarization">N-velarization n→ŋ (Dominican)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="ceceo" checked>
                <label for="ceceo">Ceceo distinction θ≠s (Cádiz)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="finalRDeletionCadiz" checked>
                <label for="finalRDeletionCadiz">Final r-deletion in infinitives (Cádiz casual)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="finalSDeletion" checked>
                <label for="finalSDeletion">Final s-deletion/aspiration (Cádiz)</label>
              </div>

              <!-- From your “Complete Engine” toggles -->
              <div class="feature-item">
                <input type="checkbox" id="liquidSub" checked>
                <label for="liquidSub">Liquid substitution r→l̪ (Dominican)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="sDelete" checked>
                <label for="sDelete">S-deletion (Dominican)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="assibilatedR" checked>
                <label for="assibilatedR">Assibilated r→ʂ (Mexican)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="sheismo" checked>
                <label for="sheismo">Sheísmo ll/y→ʃ (Rioplatense)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="sAspiration" checked>
                <label for="sAspiration">S-aspiration s→h (Rioplatense)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="finalRDeletion" checked>
                <label for="finalRDeletion">Final tap deletion (Rioplatense casual)</label>
              </div>
              <div class="feature-item">
                <input type="checkbox" id="showSyllables" checked>
                <label for="showSyllables">Show syllable boundaries</label>
              </div>
            </div>
          </div>

          <div class="output-section panel" id="outputSection" style="display:none;">
            <h2>IPA Transcription</h2>
            <div class="transcription-result" id="transcriptionResult"></div>
          </div>
        </div>

        <!-- Mini side panel (kept because it existed in your original mix) -->
        <div class="side-panel">
          <div class="mini-panel">
            <h3>Mini Transcriptor (same engine)</h3>
            <div class="small">This mirrors the main engine. Output below:</div>
            <div class="mini-output" id="miniOutput">[ ]</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ======================
   Shared constants
====================== */
const vowels = 'aeiou';
const weakVowels = 'iu';
const consonants = 'bβdðgɣptkfθsxmnɲlrɾʝtʃɲjʃʒRθjwŋ';
const validClusters = ['bl','br','kl','kr','dl','dr','fl','fr','gl','gr','pl','pr','tl','tr'];

/* ============================================================
   Step 1: Orthography → phonemes  (ONLY CHANGE: ch→tʃ goes first)
   ============================================================ */
function orthographyToPhonemes(text, dialect) {
  let result = (text || '').toLowerCase();

  // --- ONLY FIX YOU REQUESTED: handle 'ch' FIRST ---
  result = result.replace(/ch/g, 'tʃ');

  // Remove silent h
  result = result.replace(/h/g, '');

  // Digraphs already handled: ch; handle ll as yeísmo base (rioplatense toggle adjusts later)
  result = result.replace(/ll/g, 'ʝ');

  // rr → r (we’ll re-mark later in rules if needed)
  result = result.replace(/rr/g, 'r');

  // qu → k
  result = result.replace(/qu/g, 'k');

  // c/z (dialect-specific base)
  if (dialect === 'cadiz') {
    result = result.replace(/c([ei])/g, 'θ$1');
    result = result.replace(/z/g, 'θ');
  } else {
    result = result.replace(/c([ei])/g, 's$1');
    result = result.replace(/z/g, 's');
  }
  result = result.replace(/c/g, 'k');

  // g before e,i
  result = result.replace(/g([ei])/g, 'x$1');
  result = result.replace(/gu([ei])/g, 'g$1');

  // v→b
  result = result.replace(/v/g, 'b');

  // y rules (very simple)
  result = result.replace(/y(?=[aeiou])/g, 'ʝ');
  result = result.replace(/y$/g, 'i');
  result = result.replace(/([aeiou])y/g, '$1i');
  result = result.replace(/^y/g, 'ʝ');

  // j→x
  result = result.replace(/j/g, 'x');

  // ñ
  result = result.replace(/ñ/g, 'ɲ');

  // final r mark and taps
  result = result.replace(/r$/g, 'R'); // mark final (will be handled in rules)
  result = result.replace(/r/g, 'ɾ');

  return result;
}

/* ============================================================
   Step 2: Syllabification (with diphthongs/hiatus + clusters)
   ============================================================ */
function syllabify(phonemes, originalWord) {
  // detect stressed weak vowels (í/ú) positions mapped to vowel index in phoneme stream
  const vowelsSet = new Set(vowels.split(''));
  const weakSet = new Set(weakVowels.split(''));
  const stressedWeakVowels = new Set();

  if (originalWord && originalWord.length) {
    let phonemePos = 0;
    for (let i = 0; i < originalWord.length; i++) {
      const ch = originalWord[i];
      const base = ch.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
      const isV = vowelsSet.has(base);
      if (ch === 'í' || ch === 'Í' || ch === 'ú' || ch === 'Ú') {
        stressedWeakVowels.add(phonemePos);
      }
      if (isV) phonemePos++;
    }
  }

  // build diphthongs (weak → glide if unstressed)
  let processed = '';
  let vowelIndex = 0;

  for (let i = 0; i < phonemes.length; i++) {
    const a = phonemes[i];
    const b = phonemes[i + 1];
    const aIsV = vowelsSet.has(a);
    const bIsV = b ? vowelsSet.has(b) : false;

    if (aIsV && bIsV) {
      const aWeak = weakSet.has(a);
      const bWeak = weakSet.has(b);
      const aStressedWeak = aWeak && stressedWeakVowels.has(vowelIndex);
      const bStressedWeak = bWeak && stressedWeakVowels.has(vowelIndex + 1);

      const isDip =
        (!aStressedWeak && !bStressedWeak) && (
          (aWeak && !bWeak) || (!aWeak && bWeak) || (aWeak && bWeak)
        );

      if (isDip) {
        if (aWeak) processed += (a === 'i' ? 'j' : 'w') + b;
        else if (bWeak) processed += a + (b === 'i' ? 'j' : 'w');
        i++;
        vowelIndex += 2;
        continue;
      } else {
        processed += a;
        vowelIndex += 1;
        continue;
      }
    }

    processed += a;
    if (aIsV) vowelIndex += 1;
  }

  // syllable split using clusters list
  const syllables = [];
  let cur = '';
  let i = 0;
  while (i < processed.length) {
    const ch = processed[i];
    cur += ch;

    if (vowels.includes(ch)) {
      // gather following consonants
      let j = i + 1;
      let cons = '';
      while (j < processed.length && !vowels.includes(processed[j])) {
        cons += processed[j];
        j++;
      }

      if (cons.length === 0) {
        syllables.push(cur); cur = ''; i++; continue;
      }

      if (cons.length === 1) {
        syllables.push(cur); cur = cons; i = i + 2; continue;
      }

      const lastTwo = cons.slice(-2);
      if (validClusters.includes(lastTwo)) {
        const coda = cons.slice(0, -2);
        cur += coda;
        syllables.push(cur);
        cur = lastTwo;
        i = j;
      } else {
        const coda = cons.slice(0, -1);
        cur += coda;
        syllables.push(cur);
        cur = cons.slice(-1);
        i = j;
      }
      continue;
    }
    i++;
  }
  if (cur) syllables.push(cur);
  return syllables;
}

/* ==========================
   Step 3: Stress assignment
========================== */
function applyStress(syllables, originalWord) {
  if (!syllables.length) return syllables;

  // explicit acute?
  const acute = originalWord && originalWord.match(/[áéíóú]/);
  if (acute) {
    const map = { 'á':'a','é':'e','í':'i','ó':'o','ú':'u',
                  'Á':'a','É':'e','Í':'i','Ó':'o','Ú':'u' };
    const v = map[acute[0]];
    for (let i = syllables.length - 1; i >= 0; i--) {
      if (syllables[i].includes(v)) {
        syllables[i] = 'ˈ' + syllables[i];
        return syllables;
      }
    }
  }

  const lastCh = originalWord?.[originalWord.length - 1] || '';
  const endsVNS = /[aeioun]$/i.test(lastCh);
  const idx = (syllables.length === 1)
    ? 0
    : (endsVNS ? syllables.length - 2 : syllables.length - 1);

  syllables[idx] = 'ˈ' + syllables[idx];
  return syllables;
}

/* ===========================================
   Step 4: Phonological rules per dialect/toggles
=========================================== */
function applyRules(syllables, dialect, features) {
  return syllables.map((syllable, index, arr) => {
    let result = syllable;

    // preserve and remove stress to operate
    const hadStress = result.includes('ˈ');
    if (hadStress) result = result.replace('ˈ', '');

    // Cádiz liquid substitution (r/ɾ → l̪) in coda or final
    if (dialect === 'cadiz' && features.liquidSubCadiz) {
      const last = index === arr.length - 1;
      if (last) result = result.replace(/[ɾrR]$/, 'l̪');
      result = result.replace(/[ɾrR](?=[bβdðgɣptkfθsxmnɲʝtʃjʃʒRθjwŋ])/g, 'l̪');
    }

    // Cádiz final r deletion in infinitives (casual; simplified)
    if (dialect === 'cadiz' && features.finalRDeletionCadiz) {
      const last = index === arr.length - 1;
      if (last) result = result.replace(/[ɾrR]$/, ''); // simplified per your original
    }

    // Cádiz final s-deletion/aspiration (simplified)
    if (dialect === 'cadiz' && features.finalSDeletion) {
      const last = index === arr.length - 1;
      if (last) result = result.replace(/[sθ]$/, 'h');
      result = result.replace(/[sθ](?=[bβdðgɣptkfxmnɲʝtʃjʃʒRθ])/g, 'h');
    }

    // Rioplatense: keep R→r at word end; else R→ɾ
    if (dialect === 'rioplatense') {
      const last = index === arr.length - 1;
      if (last && /R/.test(result)) result = result.replace(/R/g, 'r');
      else result = result.replace(/R/g, 'ɾ');
    } else {
      result = result.replace(/R/g, 'ɾ');
    }

    // Rioplatense: sheísmo
    if (dialect === 'rioplatense' && features.sheismo) {
      result = result.replace(/ʝ/g, 'ʃ');
    }

    // Rioplatense: s aspiration (simple)
    if (dialect === 'rioplatense' && features.sAspiration) {
      const last = index === arr.length - 1;
      if (last) result = result.replace(/s$/, 'h');
      result = result.replace(/s(?=[bβdðgɣptkfθxmnɲʝtʃjʃʒRθ])/g, 'h');
    }

    // Rioplatense: optional final tap deletion
    if (dialect === 'rioplatense' && features.finalRDeletion) {
      const last = index === arr.length - 1;
      if (last) result = result.replace(/ɾ$/, '');
    }

    // Dominican: n final → ŋ
    if (dialect === 'dominican' && features.nVelarization) {
      const last = index === arr.length - 1;
      if (last) result = result.replace(/n$/, 'ŋ');
    }

    // Dominican: liquid substitution toggle (separate from Cádiz)
    if (dialect === 'dominican' && features.liquidSub) {
      const last = index === arr.length - 1;
      if (last) result = result.replace(/[ɾrR]$/, 'l̪');
      result = result.replace(/[ɾrR](?=[bβdðgɣptkfθsxmnɲʝtʃjʃʒRθ])/g, 'l̪');
    }

    // Dominican: s-deletion (simple)
    if (dialect === 'dominican' && features.sDelete) {
      result = result.replace(/s$/g, '');
      result = result.replace(/s(?=[ptkg])/g, '');
    }

    // Mexican: assibilated R (very simplified)
    if (dialect === 'mexican' && features.assibilatedR) {
      if (!/^(ɾ|r|R)/.test(result)) {
        result = result.replace(/ɾ/g, 'ʂ').replace(/r/g, 'ʂ').replace(/R/g, 'ʂ');
      }
    }

    // Spanish lenition (very rough, as in your original idea)
    result = result.replace(/b(?![mnɲ])/g, 'β');
    result = result.replace(/([mnɲ])β/g, '$1b');
    result = result.replace(/d/g, 'ð');
    result = result.replace(/([mnɲl̪])ð/g, '$1d');
    result = result.replace(/g(?![mnɲ])/g, 'ɣ');
    result = result.replace(/([mnɲ])ɣ/g, '$1g');

    // Add dental diacritic to l (as your original did)
    result = result.replace(/l(?!̪)/g, 'l̪');

    if (hadStress) result = 'ˈ' + result;
    return result;
  });
}

/* ==========================
   Step 5: Full transcription
========================== */
function transcribe() {
  const input = document.getElementById('inputText').value || '';
  if (!input.trim()) return;

  const dialect = document.getElementById('dialectSelect').value;
  const features = {
    // from your first block
    liquidSubCadiz: document.getElementById('liquidSubCadiz')?.checked,
    nVelarization: document.getElementById('nVelarization')?.checked,
    ceceo: document.getElementById('ceceo')?.checked,
    finalRDeletionCadiz: document.getElementById('finalRDeletionCadiz')?.checked,
    finalSDeletion: document.getElementById('finalSDeletion')?.checked,

    // from your complete engine block
    liquidSub: document.getElementById('liquidSub')?.checked,
    sDelete: document.getElementById('sDelete')?.checked,
    assibilatedR: document.getElementById('assibilatedR')?.checked,
    sheismo: document.getElementById('sheismo')?.checked,
    sAspiration: document.getElementById('sAspiration')?.checked,
    finalRDeletion: document.getElementById('finalRDeletion')?.checked,
    showSyllables: document.getElementById('showSyllables')?.checked
  };

  // basic tokenization (keep faithful to your style)
  const words = input.toLowerCase().replace(/[,!()]/g, ' ').split(/\s+/).filter(w => w.trim());

  const out = [];
  for (const word of words) {
    let phon = orthographyToPhonemes(word, dialect);
    let syls = syllabify(phon, word);
    syls = applyStress(syls, word);

    // Dominican initial r→ɣ rule (as in your original)
    if (dialect === 'dominican' && syls[0] &&
        (/^ˈ?[ɾrR]/.test(syls[0]))) {
      if (syls[0].startsWith('ˈɾ') || syls[0].startsWith('ˈr') || syls[0].startsWith('ˈR')) {
        syls[0] = 'ˈɣ' + syls[0].slice(2);
      } else if (syls[0].startsWith('ɾ') || syls[0].startsWith('r') || syls[0].startsWith('R')) {
        syls[0] = 'ɣ' + syls[0].slice(1);
      }
    }

    syls = applyRules(syls, dialect, features);
    out.push(features.showSyllables ? syls.join('.') : syls.join(''));
  }

  const finalOut = `[${out.join(' ')}]`;
  document.getElementById('transcriptionResult').textContent = finalOut;
  document.getElementById('outputSection').style.display = 'block';
  document.getElementById('miniOutput').textContent = finalOut;
}

// demo text from your block
document.getElementById('inputText').value = 'hola chicos ..';
</script>
</body>
</html>
